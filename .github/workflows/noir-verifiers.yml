name: Noir Verifier Generation

on:
  push:
    paths:
      - 'noir/**'
      - 'contracts/verifiers/**'
      - 'scripts/generate_verifiers.sh'
    branches:
      - main
      - develop
  pull_request:
    paths:
      - 'noir/**'
      - 'contracts/verifiers/**'
      - 'scripts/generate_verifiers.sh'
  schedule:
    - cron: '0 0 * * 0'
  workflow_dispatch:
    inputs:
      force_regenerate:
        description: 'Force regenerate all verifiers'
        required: false
        default: false
        type: boolean

env:
  NARGO_VERSION: "0.35.0"
  BB_VERSION: "0.55.0"
  FOUNDRY_PROFILE: ci

jobs:
  # ============================================
  # Job 1: Compile Noir Circuits
  # ============================================
  compile-circuits:
    name: Compile Noir Workspace
    runs-on: ubuntu-latest

    outputs:
      circuits_compiled: ${{ steps.compile.outputs.count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache Noir toolchain
        uses: actions/cache@v4
        id: cache-nargo
        with:
          path: ~/.nargo
          key: nargo-${{ env.NARGO_VERSION }}-${{ runner.os }}

      - name: Install Noir toolchain
        if: steps.cache-nargo.outputs.cache-hit != 'true'
        run: |
          curl -L https://raw.githubusercontent.com/noir-lang/noirup/main/install | bash
          ~/.nargo/bin/noirup -v ${{ env.NARGO_VERSION }}

      - name: Add Noir to PATH
        run: echo "$HOME/.nargo/bin" >> $GITHUB_PATH

      - name: Verify Noir installation
        run: |
          nargo --version
          echo "Expected: nargo ${{ env.NARGO_VERSION }}"

      - name: Cache Noir compilation
        uses: actions/cache@v4
        with:
          path: noir/target
          key: noir-target-${{ hashFiles('noir/**/src/**', 'noir/**/Nargo.toml') }}
          restore-keys: |
            noir-target-

      - name: Compile Noir workspace
        id: compile
        run: |
          cd noir
          nargo compile --workspace 2>&1 | tee compile.log || true

          # Count compiled circuits
          CIRCUIT_COUNT=$(ls -1 target/*.json 2>/dev/null | wc -l || echo "0")
          echo "count=$CIRCUIT_COUNT" >> $GITHUB_OUTPUT
          echo "Compiled $CIRCUIT_COUNT circuits"
        continue-on-error: true

      - name: List compiled circuits
        run: |
          echo "## Compiled Noir Circuits" >> $GITHUB_STEP_SUMMARY
          cd noir/target 2>/dev/null && ls -1 *.json 2>/dev/null | sed 's/.json$//' >> $GITHUB_STEP_SUMMARY || echo "No circuits compiled" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload compiled circuits
        uses: actions/upload-artifact@v4
        with:
          name: noir-compiled
          path: noir/target/*.json
          retention-days: 7
          if-no-files-found: warn

  # ============================================
  # Job 2: Generate Solidity Verifiers
  # ============================================
  generate-verifiers:
    name: Generate Solidity Verifiers
    runs-on: ubuntu-latest
    needs: compile-circuits

    outputs:
      verifiers_generated: ${{ steps.generate.outputs.count }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download compiled circuits
        uses: actions/download-artifact@v4
        with:
          name: noir-compiled
          path: noir/target
        continue-on-error: true

      - name: Cache Barretenberg
        uses: actions/cache@v4
        id: cache-bb
        with:
          path: ~/.bb
          key: bb-${{ env.BB_VERSION }}-${{ runner.os }}

      - name: Install Barretenberg
        if: steps.cache-bb.outputs.cache-hit != 'true'
        run: |
          mkdir -p ~/.bb/bin
          curl -L "https://github.com/AztecProtocol/aztec-packages/releases/download/aztec-packages-v${{ env.BB_VERSION }}/barretenberg-x86_64-linux.tar.gz" | tar xz -C ~/.bb/bin
        continue-on-error: true

      - name: Add Barretenberg to PATH
        run: echo "$HOME/.bb/bin" >> $GITHUB_PATH

      - name: Generate verifiers
        id: generate
        run: |
          mkdir -p contracts/verifiers/generated
          chmod +x scripts/generate_verifiers.sh
          ./scripts/generate_verifiers.sh 2>&1 | tee generate.log || true

          VERIFIER_COUNT=$(ls -1 contracts/verifiers/generated/*.sol 2>/dev/null | wc -l || echo "0")
          echo "count=$VERIFIER_COUNT" >> $GITHUB_OUTPUT
          echo "Generated $VERIFIER_COUNT verifiers"
        continue-on-error: true

      - name: Upload generated verifiers
        uses: actions/upload-artifact@v4
        with:
          name: generated-verifiers
          path: contracts/verifiers/generated/*.sol
          retention-days: 30
          if-no-files-found: warn

  # ============================================
  # Job 3: Gas Benchmarks
  # ============================================
  gas-benchmark:
    name: Run Gas Benchmarks
    runs-on: ubuntu-latest
    needs: [compile-circuits]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run gas benchmark tests
        run: |
          if [ -d "test/gas" ] && ls test/gas/*.sol 1>/dev/null 2>&1; then
            forge test --match-path "test/gas/*" --gas-report 2>&1 | tee gas-report.txt || true
          else
            echo "No gas benchmark tests found" > gas-report.txt
          fi

          echo "## Gas Report Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 gas-report.txt >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No gas data" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

      - name: Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt
          retention-days: 30
          if-no-files-found: warn

  # ============================================
  # Job 4: Summary Report
  # ============================================
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [compile-circuits, generate-verifiers, gas-benchmark]
    if: always()

    steps:
      - name: Generate workflow summary
        run: |
          echo "# Noir Verifier Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Circuits Compiled | ${{ needs.compile-circuits.outputs.circuits_compiled || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Verifiers Generated | ${{ needs.generate-verifiers.outputs.verifiers_generated || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Gas Benchmarks | ${{ needs.gas-benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Toolchain Versions:**" >> $GITHUB_STEP_SUMMARY
          echo "- Nargo: ${{ env.NARGO_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Barretenberg: ${{ env.BB_VERSION }}" >> $GITHUB_STEP_SUMMARY
